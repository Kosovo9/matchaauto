worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Optimizaciones de Red 210x
    sendfile        on;
    keepalive_timeout  65;
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;

    # Upstreams para los 3 Cerebros
    upstream matchauto_backend { server backend:8787; }
    upstream marketplace_backend { server marketplace:8788; }
    upstream assets_backend { server assets:8789; }

    # Configuración para match-autos.com (Global Marketplace & Public)
    server {
        listen 80;
        server_name match-autos.com www.match-autos.com;

        location / {
            proxy_pass http://frontend:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/v1/ { proxy_pass http://matchauto_backend/; }
        location /marketplace/api/ { proxy_pass http://marketplace_backend/; }
        location /assets/api/ { proxy_pass http://assets_backend/; }
    }

    # Configuración para match-autos.ad (Security Hub & Leader Portal)
    server {
        listen 80;
        server_name match-autos.ad www.match-autos.ad;

        # Header de Seguridad Presidencial
        add_header X-Security-Level "ANDORRA-SOVEREIGN-1000X";

        location / {
            proxy_pass http://frontend:3000;
            proxy_set_header Host $host;
        }

        # Backends (con acceso a reportes sensibles)
        location /api/v1/ { proxy_pass http://matchauto_backend/; }
        location /marketplace/api/ { proxy_pass http://marketplace_backend/; }
        location /assets/api/ { proxy_pass http://assets_backend/; }
    }
}
